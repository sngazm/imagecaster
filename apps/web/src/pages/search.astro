---
import Layout from "../layouts/Layout.astro";
---

<Layout title="検索" description="エピソードを検索">
  <div class="mx-auto max-w-4xl px-4 py-8 sm:py-10">
    <h1 class="mb-6 text-xl font-semibold text-text dark:text-text-dark">
      エピソード検索
    </h1>

    <!-- 検索フォーム -->
    <div class="mb-6">
      <div class="relative">
        <input
          type="text"
          id="search-input"
          placeholder="キーワードを入力..."
          class="w-full rounded-lg border border-border bg-bg-elevated px-4 py-2.5 pl-10 text-sm text-text placeholder-text-muted focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/20 dark:border-border-dark dark:bg-bg-elevated-dark dark:text-text-dark dark:placeholder-text-muted-dark"
        />
        <svg
          class="absolute left-3.5 top-1/2 h-4 w-4 -translate-y-1/2 text-text-muted dark:text-text-muted-dark"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
          />
        </svg>
      </div>
      <p class="mt-1.5 text-xs text-text-muted dark:text-text-muted-dark">
        エピソードのタイトル、概要、文字起こしから検索できます
      </p>
    </div>

    <!-- 検索結果 -->
    <div id="search-results" class="space-y-3">
      <p class="text-sm text-text-muted dark:text-text-muted-dark">
        検索キーワードを入力してください
      </p>
    </div>
  </div>
</Layout>

<script is:inline>
  // Pagefindインスタンスをグローバルに保持
  window.__pagefind = window.__pagefind || null;

  async function initPagefind() {
    const input = document.getElementById("search-input");
    const resultsContainer = document.getElementById("search-results");

    if (!input || !resultsContainer) return;

    // Pagefindを動的にロード（既存インスタンスがあれば再利用）
    let pagefind = window.__pagefind;
    if (!pagefind) {
      try {
        pagefind = await import("/pagefind/pagefind.js");
        await pagefind.init();
        window.__pagefind = pagefind;
      } catch (e) {
        console.error("Pagefind not available:", e);
        resultsContainer.innerHTML = `
          <p class="text-sm text-text-muted dark:text-text-muted-dark">
            検索機能は現在利用できません
          </p>
        `;
        return;
      }
    }

    async function performSearch(query) {
      if (!query) {
        resultsContainer.innerHTML = `
          <p class="text-sm text-text-muted dark:text-text-muted-dark">
            検索キーワードを入力してください
          </p>
        `;
        return;
      }

      resultsContainer.innerHTML = `
        <p class="text-sm text-text-muted dark:text-text-muted-dark">
          検索中...
        </p>
      `;

      try {
        // 日本語検索のためクエリを単語分割
        const segmentedQuery = segmentSearchQuery(query);
        const search = await pagefind.search(segmentedQuery);
        const results = await Promise.all(
          search.results.slice(0, 20).map((r) => r.data())
        );

        if (results.length === 0) {
          resultsContainer.innerHTML = `
            <p class="text-sm text-text-muted dark:text-text-muted-dark">
              「${escapeHtml(query)}」に一致する結果が見つかりませんでした
            </p>
          `;
          return;
        }

        resultsContainer.innerHTML = `
          <p class="mb-3 text-xs text-text-muted dark:text-text-muted-dark">
            ${search.results.length}件の結果
          </p>
          <div class="space-y-3">
            ${results.map((r) => `
              <a
                href="${r.url}"
                class="block rounded-lg border border-border bg-bg-elevated p-3 transition-colors hover:border-border-subtle hover:bg-bg-subtle dark:border-border-dark dark:bg-bg-elevated-dark dark:hover:border-border-subtle-dark dark:hover:bg-bg-subtle-dark"
              >
                <h2 class="mb-1 text-sm font-semibold text-text dark:text-text-dark">
                  ${escapeHtml(r.meta?.title || "無題")}
                </h2>
                <p class="text-xs text-text-secondary dark:text-text-secondary-dark">
                  ${r.excerpt || ""}
                </p>
              </a>
            `).join("")}
          </div>
        `;
      } catch (error) {
        console.error("Search error:", error);
        resultsContainer.innerHTML = `
          <p class="text-sm text-error">
            検索中にエラーが発生しました
          </p>
        `;
      }
    }

    let debounceTimer;
    input.addEventListener("input", () => {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => {
        performSearch(input.value.trim());
      }, 300);
    });

    // URLパラメータから初期検索
    const params = new URLSearchParams(window.location.search);
    const q = params.get("q");
    if (q) {
      input.value = q;
      performSearch(q);
    }
  }

  function escapeHtml(str) {
    const div = document.createElement("div");
    div.textContent = str;
    return div.innerHTML;
  }

  // 日本語検索クエリをセグメント化する
  // Pagefindは検索クエリのセグメンテーションをサポートしていないため、
  // Intl.Segmenterを使って事前に単語分割する
  function segmentSearchQuery(query) {
    // Intl.Segmenterがサポートされていない場合はそのまま返す
    if (typeof Intl.Segmenter === "undefined") {
      return query;
    }

    try {
      const segmenter = new Intl.Segmenter("ja", { granularity: "word" });
      const segments = Array.from(segmenter.segment(query));

      // 単語のみを抽出してスペースで結合
      const words = segments
        .filter((s) => s.isWordLike)
        .map((s) => s.segment);

      return words.join(" ");
    } catch (e) {
      console.warn("Segmentation failed, using original query:", e);
      return query;
    }
  }

  // 初回ロード時とView Transitionsでのページ遷移時に実行
  document.addEventListener("astro:page-load", initPagefind);
</script>
