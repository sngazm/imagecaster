---
import Layout from "../layouts/Layout.astro";
import EpisodeCard from "../components/EpisodeCard.astro";
import SubscribeSection from "../components/SubscribeSection.astro";
import Pagination from "../components/Pagination.astro";
import { getPublishedEpisodes, getPodcastIndex } from "../lib/api";

const EPISODES_PER_PAGE = 10;
const currentPage = 1;

const allEpisodes = await getPublishedEpisodes();
const index = await getPodcastIndex();
const podcast = index.podcast;

const totalPages = Math.ceil(allEpisodes.length / EPISODES_PER_PAGE);
const episodes = allEpisodes.slice(0, EPISODES_PER_PAGE);
---

<Layout title={podcast.title} description={podcast.description} ogImage={podcast.ogImageUrl || podcast.artworkUrl}>
  <div class="mx-auto max-w-4xl px-4 py-8 sm:py-10">
    <!-- ヒーローセクション -->
    <section class="mb-10">
      <div class="flex flex-col items-center gap-5 sm:flex-row sm:items-start">
        {podcast.artworkUrl && (
          <img
            src={podcast.artworkUrl}
            alt={podcast.title}
            class="h-40 w-40 shrink-0 rounded-xl shadow-md sm:h-36 sm:w-36"
          />
        )}
        <div class="text-left">
          <h1 class="mb-2 text-lg text-center font-semibold tracking-tight text-text dark:text-text-dark sm:text-xl sm:text-left">
            {podcast.title}
          </h1>
          <p class="text-sm leading-relaxed text-text-secondary dark:text-text-secondary-dark">
            {podcast.description}
          </p>
        </div>
      </div>
    </section>

    <div class="grid gap-6 lg:grid-cols-3 lg:gap-8">
      <!-- エピソード一覧 -->
      <div class="min-w-0 lg:col-span-2">
        <h2 class="mb-4 text-base font-semibold text-text dark:text-text-dark">
          エピソード
          <span class="ml-1.5 text-sm font-normal text-text-muted dark:text-text-muted-dark">({allEpisodes.length})</span>
        </h2>

        {episodes.length === 0 ? (
          <div class="rounded-lg border border-border bg-bg-elevated p-6 text-center dark:border-border-dark dark:bg-bg-elevated-dark">
            <p class="text-sm text-text-muted dark:text-text-muted-dark">
              まだエピソードがありません
            </p>
          </div>
        ) : (
          <div class="space-y-3">
            {episodes.map((episode) => (
              <EpisodeCard episode={episode} websiteUrl={podcast.websiteUrl} />
            ))}
          </div>
        )}

        <Pagination currentPage={currentPage} totalPages={totalPages} />
      </div>

      <!-- サイドバー -->
      <aside class="space-y-4">
        <SubscribeSection podcast={podcast} />

        {podcast.author && (
          <section class="rounded-lg border border-border bg-bg-elevated p-4 dark:border-border-dark dark:bg-bg-elevated-dark">
            <h2 class="mb-2 text-sm font-semibold text-text dark:text-text-dark">
              ホスト
            </h2>
            <p class="text-sm text-text-secondary dark:text-text-secondary-dark">
              {podcast.author}
            </p>
          </section>
        )}
      </aside>
    </div>
  </div>
</Layout>
