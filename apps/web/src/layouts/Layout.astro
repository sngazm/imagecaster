---
import { ViewTransitions } from "astro:transitions";
import { stripHtml } from "../lib/api";

interface Props {
  title: string;
  description?: string;
  ogImage?: string;
  ogType?: "website" | "article";
}

const { title, description = "ポッドキャスト配信サイト", ogImage, ogType = "website" } = Astro.props;
const siteTitle = import.meta.env.SITE_TITLE || "Podcast";
const fullTitle = title === siteTitle ? title : `${title} | ${siteTitle}`;
const plainDescription = stripHtml(description);
const canonicalUrl = Astro.url.href;

// OGP画像を絶対URLに変換（Bluesky等で必要）
function toAbsoluteUrl(url: string | undefined): string | undefined {
  if (!url) return undefined;
  if (url.startsWith("http://") || url.startsWith("https://")) {
    return url;
  }
  // 相対URLの場合はサイトURLと結合
  const siteUrl = Astro.site?.toString().replace(/\/$/, "") || Astro.url.origin;
  return `${siteUrl}${url.startsWith("/") ? "" : "/"}${url}`;
}

const absoluteOgImage = toAbsoluteUrl(ogImage);

// 開発環境でErudaを有効化（モバイルデバッグ用）
const isDev = import.meta.env.DEV;
---

<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={plainDescription} />
    <meta property="og:title" content={fullTitle} />
    <meta property="og:description" content={plainDescription} />
    <meta property="og:type" content={ogType} />
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:site_name" content={siteTitle} />
    {absoluteOgImage && (
      <>
        <meta property="og:image" content={absoluteOgImage} />
        <meta property="og:image:secure_url" content={absoluteOgImage} />
        <meta property="og:image:width" content="1200" />
        <meta property="og:image:height" content="630" />
        <meta property="og:image:alt" content={fullTitle} />
      </>
    )}
    {/* Twitter/Bluesky Card用メタタグ */}
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={fullTitle} />
    <meta name="twitter:description" content={plainDescription} />
    {absoluteOgImage && <meta name="twitter:image" content={absoluteOgImage} />}
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="alternate" type="application/rss+xml" title={siteTitle} href="/feed.xml" />
    <meta name="color-scheme" content="light dark" />
    <title>{fullTitle}</title>
    <ViewTransitions />
    <!-- テーマ初期化（FOUC防止） -->
    <script is:inline>
      (function initTheme() {
        const stored = localStorage.getItem('theme');
        if (stored === 'dark' || (stored !== 'light' && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
          document.documentElement.classList.add('dark');
        } else {
          document.documentElement.classList.remove('dark');
        }
      })();
      // View Transitionsでのページ遷移時にもテーマを再適用
      document.addEventListener('astro:after-swap', function() {
        const stored = localStorage.getItem('theme');
        if (stored === 'dark' || (stored !== 'light' && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
          document.documentElement.classList.add('dark');
        } else {
          document.documentElement.classList.remove('dark');
        }
      });
    </script>
  </head>
  <body class="min-h-screen bg-bg text-text dark:bg-bg-dark dark:text-text-dark">
    <div class="flex min-h-screen flex-col">
      <header class="sticky top-0 z-50 border-b border-border bg-bg-elevated/95 backdrop-blur-md dark:border-border-dark dark:bg-bg-elevated-dark/95">
        <div class="mx-auto flex h-14 max-w-4xl items-center justify-between px-4">
          <a href="/" class="text-lg font-semibold tracking-tight text-text transition-colors hover:text-text-secondary dark:text-text-dark dark:hover:text-text-secondary-dark">
            {siteTitle}
          </a>
          <nav class="flex items-center gap-1 md:gap-2">
            <a href="/" class="hidden rounded-md px-3 py-1.5 text-sm font-medium text-text-secondary transition-colors hover:bg-bg-subtle hover:text-text dark:text-text-secondary-dark dark:hover:bg-bg-subtle-dark dark:hover:text-text-dark sm:block">
              エピソード
            </a>
            <a href="/about" class="hidden rounded-md px-3 py-1.5 text-sm font-medium text-text-secondary transition-colors hover:bg-bg-subtle hover:text-text dark:text-text-secondary-dark dark:hover:bg-bg-subtle-dark dark:hover:text-text-dark sm:block">
              番組について
            </a>

            <!-- 検索フォーム -->
            <form id="header-search-form" action="/search" method="get" class="relative">
              <input
                type="text"
                name="q"
                placeholder="検索..."
                class="h-8 w-28 rounded-lg border border-border bg-bg-subtle pl-8 pr-3 text-sm text-text placeholder-text-muted transition-all focus:w-44 focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/20 dark:border-border-dark dark:bg-bg-subtle-dark dark:text-text-dark dark:placeholder-text-muted-dark md:w-36 md:focus:w-52"
              />
              <svg
                class="absolute left-2.5 top-1/2 h-3.5 w-3.5 -translate-y-1/2 text-text-muted dark:text-text-muted-dark"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                />
              </svg>
            </form>

            <a
              href="/feed.xml"
              target="_blank"
              rel="noopener noreferrer"
              class="flex h-8 w-8 items-center justify-center rounded-lg bg-rss text-white transition-opacity hover:opacity-90 sm:w-auto sm:gap-1.5 sm:px-3"
            >
              <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
                <path d="M6.18 15.64a2.18 2.18 0 1 1 0 4.36 2.18 2.18 0 0 1 0-4.36m0-12a14.18 14.18 0 0 1 14.18 14.18h-3.27A10.91 10.91 0 0 0 6.18 6.91V3.64m0 6.55a7.64 7.64 0 0 1 7.64 7.63H10.5a4.36 4.36 0 0 0-4.32-4.36v-3.27Z"/>
              </svg>
              <span class="hidden text-sm font-medium sm:inline">RSS</span>
            </a>

            <!-- テーマ切り替えボタン -->
            <button
              id="theme-toggle"
              type="button"
              class="flex h-8 w-8 items-center justify-center rounded-lg text-text-muted transition-colors hover:bg-bg-subtle hover:text-text dark:text-text-muted-dark dark:hover:bg-bg-subtle-dark dark:hover:text-text-dark"
              aria-label="テーマ切り替え"
              title="テーマ切り替え"
            >
              <!-- ライト固定: 太陽アイコン -->
              <svg id="theme-icon-light" class="hidden h-[18px] w-[18px]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
              </svg>
              <!-- ダーク固定: 月アイコン -->
              <svg id="theme-icon-dark" class="hidden h-[18px] w-[18px]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
              </svg>
              <!-- システム: モニターアイコン -->
              <svg id="theme-icon-system" class="hidden h-[18px] w-[18px]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
              </svg>
            </button>
          </nav>
        </div>
      </header>

      <main class="flex-1">
        <slot />
      </main>

      <footer class="border-t border-border py-6 dark:border-border-dark">
        <div class="mx-auto max-w-4xl px-4 text-center text-sm text-text-muted dark:text-text-muted-dark">
          <p>© {new Date().getFullYear()} {siteTitle}</p>
        </div>
      </footer>
    </div>

    <script>
      // テーマ: 'light' | 'dark' | null (system)
      function getThemeSetting() {
        return localStorage.getItem('theme'); // 'light', 'dark', or null
      }

      function applyTheme(setting: string | null) {
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        const isDark = setting === 'dark' || (setting === null && prefersDark);
        document.documentElement.classList.toggle('dark', isDark);
      }

      function updateThemeIcon(setting: string | null) {
        const lightIcon = document.getElementById('theme-icon-light');
        const darkIcon = document.getElementById('theme-icon-dark');
        const systemIcon = document.getElementById('theme-icon-system');
        const toggle = document.getElementById('theme-toggle');

        lightIcon?.classList.add('hidden');
        darkIcon?.classList.add('hidden');
        systemIcon?.classList.add('hidden');

        if (setting === 'light') {
          lightIcon?.classList.remove('hidden');
          toggle?.setAttribute('title', 'ライトモード（クリックでダークに）');
        } else if (setting === 'dark') {
          darkIcon?.classList.remove('hidden');
          toggle?.setAttribute('title', 'ダークモード（クリックで自動に）');
        } else {
          systemIcon?.classList.remove('hidden');
          toggle?.setAttribute('title', '自動（クリックでライトに）');
        }
      }

      function cycleTheme() {
        const current = getThemeSetting();
        let next: string | null;

        // ライト → ダーク → システム → ライト...
        if (current === 'light') {
          next = 'dark';
        } else if (current === 'dark') {
          next = null; // system
        } else {
          next = 'light';
        }

        if (next === null) {
          localStorage.removeItem('theme');
        } else {
          localStorage.setItem('theme', next);
        }

        applyTheme(next);
        updateThemeIcon(next);
      }

      function setupThemeToggle() {
        const toggle = document.getElementById('theme-toggle');
        // イベントリスナーの重複を防ぐ
        toggle?.removeEventListener('click', cycleTheme);
        toggle?.addEventListener('click', cycleTheme);

        // 現在の設定でアイコンを更新
        const setting = getThemeSetting();
        updateThemeIcon(setting);
      }

      // 初回ロード時とView Transitionsでのページ遷移時に実行
      setupThemeToggle();
      document.addEventListener('astro:after-swap', setupThemeToggle);

      // システム設定の変更を監視（システムモード時のみ反映）
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
        const setting = getThemeSetting();
        if (setting === null) {
          document.documentElement.classList.toggle('dark', e.matches);
        }
      });
    </script>

    {/* 開発環境でErudaを有効化（モバイルデバッグ用） */}
    {isDev && (
      <script>
        import("eruda").then((eruda) => {
          eruda.default.init();
        });
      </script>
    )}
  </body>
</html>

<style is:global>
  @import "../styles/global.css";
</style>
